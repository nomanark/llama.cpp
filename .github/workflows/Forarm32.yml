name: Cross-compile llama.cpp for ARMv7-A

on:
  workflow_dispatch:

jobs:
  build-armv7a:
    runs-on: ubuntu-latest

    env:
      TOOLCHAIN_PREFIX: arm-linux-gnueabihf
      TARGET_ARCH: armv7-a

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install cross-compiler toolchain and dependencies
      run: |
        sudo apt-get update
        # Install dependencies using the working package list
        sudo apt-get install -y \
          gcc-arm-linux-gnueabihf \
          g++-arm-linux-gnueabihf \
          cmake \
          make \
          libc6-dev-armhf-cross \
          libcurl4-gnutls-dev \
          libssl-dev \
          zlib1g-dev \
          pkg-config

    - name: Generate CMake Toolchain File (Critical Fix)
      run: |
        cat <<EOF > arm-toolchain.cmake
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR arm)
        # Set compilers using full paths
        set(CMAKE_C_COMPILER /usr/bin/arm-linux-gnueabihf-gcc)
        set(CMAKE_CXX_COMPILER /usr/bin/arm-linux-gnueabihf-g++)
        
        # Set the root path for finding libraries and headers
        # This tells CMake to ONLY look in the ARM-specific directories
        set(CMAKE_FIND_ROOT_PATH /usr/arm-linux-gnueabihf /usr/lib/arm-linux-gnueabihf /usr)
        
        # Critical: Force CMake to ONLY search within CMAKE_FIND_ROOT_PATH
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        
        # Compiler flags from your working configuration
        set(CMAKE_C_FLAGS "-march=armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard -funsafe-math-optimizations")
        set(CMAKE_CXX_FLAGS "-march=armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard -funsafe-math-optimizations")
        EOF

    - name: Create build directory
      run: mkdir -p build-armv7a

    - name: Configure CMake for ARMv7-A
      working-directory: build-armv7a
      run: |
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=../arm-toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release
          
    - name: Build
      working-directory: build-armv7a
      run: make -j$(nproc)

    - name: Archive ARMv7-A binaries
      uses: actions/upload-artifact@v4
      with:
        name: llama.cpp-armv7a
        path: build-armv7a/bin/*
