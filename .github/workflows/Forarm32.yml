name: Cross-compile llama.cpp for ARMv7-A (using Clang)

on:
  workflow_dispatch:

jobs:
  build-armv7a:
    runs-on: ubuntu-latest

    env:
      TARGET_TRIPLE: arm-linux-gnueabihf
      TARGET_SYSROOT: /usr/arm-linux-gnueabihf

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Clang cross-compiler and dependencies
      run: |
        # Ensure TARGET_TRIPLE is arm-linux-gnueabihf
        sudo apt-get update
        sudo apt-get install -y \
          clang \
          g++-${{ env.TARGET_TRIPLE }} \
          gcc-${{ env.TARGET_TRIPLE }} \
          cmake \
          make \
          libc6-dev-armhf-cross \  # <--- Essential C libs
          libcurl4-gnutls-dev \
          libssl-dev \
          zlib1g-dev \
          pkg-config \
          # ADD THIS: Ensures the correct linker/binutils are present
          binutils-${{ env.TARGET_TRIPLE }}
    
    - name: Generate Clang CMake Toolchain File
      run: |
        cat <<EOF > arm-clang-toolchain.cmake
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR arm)
        
        # 1. Specify Clang as the compiler
        set(CMAKE_C_COMPILER clang)
        set(CMAKE_CXX_COMPILER clang++)
        
        # 2. Set the target triple and sysroot for Clang
        set(CMAKE_C_COMPILER_TARGET ${{ env.TARGET_TRIPLE }})
        set(CMAKE_CXX_COMPILER_TARGET ${{ env.TARGET_TRIPLE }})
        set(CMAKE_SYSROOT ${{ env.TARGET_SYSROOT }})

        # 4. Set the search mode strictly to target files
        set(CMAKE_FIND_ROOT_PATH ${{ env.TARGET_SYSROOT }} /usr/lib/${{ env.TARGET_TRIPLE }})
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        
        # 5. Compiler flags (FIX: Added -B linker path)
        set(COMMON_FLAGS "-march=armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard -funsafe-math-optimizations -B/usr/${{ env.TARGET_TRIPLE }}/usr/lib/")
        set(CMAKE_C_FLAGS "\${COMMON_FLAGS}")
        set(CMAKE_CXX_FLAGS "\${COMMON_FLAGS}")
        EOF
    
    - name: Cache build
      uses: actions/cache@v4
      with:
        path: |
          build-armv7a
          ~/.cache
        key: ${{ runner.os }}-build-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-build-

    - name: Create build directory
      run: mkdir -p build-armv7a

    - name: Configure CMake for ARMv7-A (using Clang)
      working-directory: build-armv7a
      run: |
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=../arm-clang-toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release
          
    - name: Build
      working-directory: build-armv7a
      run: make -j$(nproc)

    - name: Archive ARMv7-A binaries
      uses: actions/upload-artifact@v4
      with:
        name: llama.cpp-armv7a
        path: build-armv7a/bin/*
